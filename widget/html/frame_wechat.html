<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>我的申诉</title>
    <link rel="stylesheet" type="text/css" href="../css/api.css" />
    <link rel="stylesheet" type="text/css" href="../css/style.css" />
    <style>
        body,
        html {
            background-color: transparent;
        }
    </style>
</head>

<body>
    <div class="wechat-container" tapmode onclick="api.closeFrame();">
        <div class="wechat-inner" tapmode onclick="dontClose(event);">
            <p class="wechat-title">推广二维码</p>
            <div class="wechat-content">
                <img id="wechat-pic" ontouchend="touchend()" ontouchmove="touchend()"
                    ontouchstart="touchstart(this);" />
                <p class="wechat-desc">长按图片保存二维码分享给好友，或者让好友使用微信扫一扫注册</p>
            </div>
            <div id="wechat-number" tapmode onclick="api.closeFrame();">关闭</div>
        </div>
    </div>

    <script type="text/javascript" src="../script/api.js"></script>

    <script>
        var time = 0;
        apiready = function() {
            $api.attr($api.byId('wechat-pic'), 'src', api.pageParam.wechat_img);
            getWechatImg();
        }

        function getWechatImg() {
            api.ajax({
                url: myurl + '/index.php/User/Api/wechat_img/',
                method: 'post',
                data: {
                    values: {
                        username: $api.getStorage("username"),
                        userid: $api.getStorage("userid")
                    }
                }
            }, function(ret, err) {
                if (ret) {
                  $api.attr($api.byId('wechat-pic'), 'src', geturl(ret.data.ewm));
                } else {}
            });
        }

        function dontClose(event) {
            event = event || window.event;
            event.stopPropagation();
        }

        function getTimeNow() {
            var now = new Date();
            return now.getTime();
        }

        function touchend() {
            clearInterval(time); //如果按下时间不到1000毫秒便弹起，
        }

        // 长按图片
        function touchstart(obj) {
            var timeStart = getTimeNow(); //获取鼠标按下时的时间
            time = setInterval(function() {
                var timeEnd = getTimeNow(); //也就是每100毫秒获取一次时间
                if (timeEnd - timeStart > 700) //如果此时检测到的时间与第一次获取的时间差有1000毫秒
                {
                    clearInterval(time); //便不再继续重复此函数 （clearInterval取消周期性执行）
                    savePicToAlbum();
                }
            }, 100);
        }

        // 保存图片
        function savePicToAlbum() {
            var img = $api.byId('wechat-pic');
            var src = $api.attr(img, 'src');
            var items = ['保存微信二维码到相册'];
            api.actionSheet({
                title: "保存微信二维码",
                cancelTitle: '取消',
                buttons: items
            }, function(ret, err) {
                if (ret.buttonIndex == 1) {
                    api.download({
                        url: src,
                        report: false,
                        cache: false,
                        allowResume: true
                    }, function(ret, err) {
                        if (ret.state == 1) {
                            api.saveMediaToAlbum({
                                path: ret.savePath
                            }, function(ret, err) {
                                if (ret && ret.status) {
                                    api.toast({
                                        msg: '保存成功',
                                        duration: 2000,
                                        location: 'bottom'
                                    });
                                } else {
                                    api.toast({
                                        msg: '保存失败',
                                        duration: 2000,
                                        location: 'bottom'
                                    });
                                }
                            });
                        } else {
                            api.toast({
                                msg: '下载失败',
                                duration: 2000,
                                location: 'bottom'
                            });
                        }
                    });
                }
            });
        }
    </script>
</body>

</html>
