<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>消息列表</title>
    <link rel="stylesheet" type="text/css" href="../css/api.css" />
    <link rel="stylesheet" type="text/css" href="../css/style.css" />
    <style>
        body {
            background: #fff;
            height: auto;
        }

        #contact {
            height: 40px;
            line-height: 40px;
        }

        #content {
            margin: 0;
            padding: 10px 0;
        }
    </style>
</head>

<body>
    <form id="dataForm">
        <ul class="appealaddlist">
            <li>
                <input type="text" name="contact" id="contact" value="" placeholder="手机号码" maxlength="11" />
                <li>
                    <textarea id="content" name="content" placeholder="反馈内容"></textarea>
                </li>
                <li>
                    <div class="pic_l" tapmode onclick="showAction('上传反馈图片','feedback')"><img id="feedback" src="../image/file-img.png" /></div>
                    <input type="hidden" name="feedback" id="input_feedback">
                </li>
        </ul>
        <div class="accountbtn"><input type="button" id="dobtn" tapmode onclick="postFeedback()" value="提交" /></div>
    </form>
    <script type="text/javascript" src="../script/api.js"></script>
    <script type="text/javascript" src="../script/jquery.min.js"></script>
    <script>
        apiready = function() {
            getFeedback();
        }

        function getFeedback() {
            api.showProgress();
            api.ajax({
                url: myurl + '/index.php/User/Suggestion/showlistsg/',
                method: 'post',
                data: {
                    values: {
                        username: $api.getStorage("username"),
                        userid: $api.getStorage("userid"),
                        id: api.pageParam.id
                    }
                }
            }, function(ret, err) {
                api.hideProgress();
                if (ret) {
                    if (ret.status == 1) {
                        if (!isempty(ret['contact'])) {
                            $("#contact").val(ret["contact"]);
                        }
                        if (!isempty(ret['content'])) {
                            $("#content").val(ret["content"]);
                        }
                        if (!isempty(ret['feedback'])) {
                            $("#feedback").attr("src", geturl(ret["feedback"]));
                            $("#input_feedback").val(geturl(ret["feedback"]));
                        }
                    }
                } else {
                    api.toast({
                        msg: '网络错误',
                        duration: 2000,
                        location: 'bottom'
                    });
                }
            });
        }

        function postFeedback() {
            if ($('#contact').val().trim() == '') {
                api.toast({
                    msg: '请输入手机号码',
                    duration: 2000,
                    location: 'bottom'
                });
                return false;
            }
            if ($('#contact').val().length != 11) {
                api.toast({
                    msg: '手机号码位11位',
                    duration: 2000,
                    location: 'bottom'
                });
                return false;
            }
            if (!new RegExp("^0?(13|15|16|17|18|14|19)[0-9]{9}$").test($('#contact').val())) {
                api.toast({
                    msg: '手机号码格式不正确',
                    duration: 2000,
                    location: 'bottom'
                });
                return false;
            }
            if ($('#content').val().trim() == '') {
                api.toast({
                    msg: '请输入反馈内容',
                    duration: 2000,
                    location: 'bottom'
                });
                return false;
            }
            api.showProgress();
            var param = dataFrom("dataForm");
            param['id'] = api.pageParam.id;
            api.ajax({
                url: myurl + '/index.php/User/Suggestion/postsg',
                method: 'post',
                data: {
                    values: param
                }
            }, function(ret, err) {
                api.hideProgress();
                if (ret) {
                    api.toast({
                        msg: ret.msg,
                        duration: 2000,
                        location: 'bottom'
                    });
                    if (ret.status == 1) {
                        var jsfun = 'getList()';
                        api.execScript({
                            name: 'window_feedback',
                            frameName: 'frame_feedback',
                            script: jsfun
                        });
                        setTimeout(function() {
                            api.closeWin();
                        }, 2000);
                    }
                    if (ret.status == 2) {
                        setTimeout(function() {
                            api.closeWin();
                        }, 2000);
                    }
                } else {
                    api.toast({
                        msg: '网络错误',
                        duration: 2000,
                        location: 'bottom'
                    });
                }
            });
        }

        //获取form数据
        function dataFrom(id) {
            var values = {
                "username": $api.getStorage("username"),
                "userid": $api.getStorage("userid")
            };
            var data = $('#' + id).serializeArray();
            $.each(data, function(i, v) {
                var key = v.name,
                    value = v.value;
                if (values[key]) {
                    values[key] = values[key] + ',' + value;
                } else {
                    values[key] = value;
                }
            });
            return values;
        }
    </script>
</body>

</html>
